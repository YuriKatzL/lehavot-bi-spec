# מסמך אפיון פונקציונלי
## דשבורדים לניתוח מכירות והזמנות

---

| פרט | ערך |
|-----|-----|
| **מסמך מס'** | LHV-BI-SPEC-001 |
| **גרסה** | 2.1 |
| **תאריך** | 09/02/2026 |
| **סטטוס** | טיוטה — ממתין לאישור |
| **מחבר** | יורי כץ |
| **מחלקה** | IT |
| **לקוח** | להבות מערכות כיבוי אש בע"מ |

---

## תוכן עניינים

1. [מבוא ומטרות](#1-מבוא-ומטרות)
2. [הגדרות וקיצורים](#2-הגדרות-וקיצורים)
3. [סגמנטים עסקיים](#3-סגמנטים-עסקיים)
4. [דשבורד מכירות (Sales)](#4-דשבורד-מכירות-sales)
5. [דשבורד הזמנות (Orders)](#5-דשבורד-הזמנות-orders)
6. [דשבורד הזמנות לפי תאריך אספקה (Orders by Due Date)](#6-דשבורד-הזמנות-לפי-תאריך-אספקה-orders-by-due-date)
7. [מקורות נתונים](#7-מקורות-נתונים)
8. [דרישות טכניות](#8-דרישות-טכניות)
9. [שאלות פתוחות](#9-שאלות-פתוחות)
10. [אישורים](#10-אישורים)

---

## 1. מבוא ומטרות

### 1.1 רקע

מסמך זה מגדיר את הדרישות הפונקציונליות לדשבורדי BI עבור חברת להבות מערכות כיבוי אש בע"מ.

הפרויקט מחולק לשלושה שלבים:

| Phase | תיאור | סטטוס |
|-------|-------|-------|
| **Phase 1** | מודל מכירות/שיווק | נוכחי |
| Phase 2 | מודל פיננסי (תזרים, KPI, גבייה, מסגרות) | עתידי |
| Phase 3 | מודל תפעולי (real-time delivery) | עתידי |

### 1.2 מטרות Phase 1

- מעקב אחר ביצועי מכירות בזמן אמת
- השוואת ביצועים מול תקציב (Budget)
- השוואת ביצועים מול שנה קודמת (YoY)
- מעקב אחר קצב כניסת הזמנות
- ניתוח לפי סגמנטים עסקיים

### 1.3 קהל יעד

- הנהלה בכירה (מנכ"ל, סמנכ"ל כספים)
- מנהלי מכירות
- מנהלי כספים

### 1.4 פלטפורמה

Microsoft Power BI + Priority ERP API

---

## 2. הגדרות וקיצורים

| מונח | הגדרה |
|------|-------|
| MTD | Month-to-Date — מתחילת החודש עד היום |
| QTD | Quarter-to-Date — מתחילת הרבעון עד היום |
| YTD | Year-to-Date — מתחילת השנה עד היום |
| LY | Last Year — שנה קודמת (אותה תקופה) |
| BU | Business Unit — יחידה עסקית / סגמנט |
| Budget | תקציב שנתי מחולק לחודשים |
| Due Date | תאריך אספקה צפוי של הזמנה |

---

## 3. סגמנטים עסקיים

### 3.1 רשימת סגמנטים

> **שמות סופיים (מתוך BI.pptx של אלעד, 09/02/2026):**

| # | סגמנט (שם בדשבורד) | תתי-סגמנטים | הערות |
|---|---------------------|-------------|-------|
| 1 | **שוק ביתי — מירי** | כולל פז (ביחד, אלעד אישר) | פז מקבלת עמלות רק על הדילים שלה |
| 2 | **סחר מפיצים — אילן** | — | — |
| 3 | **מערכות מנדפים — דודו** | — | תתי-סגמנט של דודו |
| 4 | **מערכות אוטובוסים — דודו** | — | תתי-סגמנט של דודו |
| 5 | **מערכות כלים חקלאים — דודו** | — | תתי-סגמנט של דודו |
| 6 | **מכירות חו"ל** | לפי מפיץ (עופר, ירון וכו') | כולל Orders by Due Date |

### 3.2 ציטוט מאלעד

> "בתוך דודו רוצים לראות אוטובוסים לבד, מטבחים לבד, שירות לבד.
> בחו"ל אפשר לחלק בין עופר לירון לפי הסוכן."

### 3.3 לוגיקת סגמנטציה בפריוריטי

**סטטוס: ✅ נבדק (09/02/2026)**

ניתוח דוח 740 (מכירות שי) במחולל הדוחות הראה שהסגמנטציה עובדת מתוך נתוני המכירות עצמם:

- **סוכן (AGENT)** — מהתעודה/הזמנה (DOCUMENTS.AGENT / ORDERS.AGENT)
- **משפחת מוצרים (FAMILY)** — מהמוצר (PART.FAMILY → FAMILY)
- **קבוצת מוצרים ראשית** — פרמטר 2 על המוצר (לקיבוץ עליון)

כל שורת מכירה כבר מכילה סוכן + משפחה → Power BI עושה pivot ומקבל סגמנטציה.

**אפשרות נוספת:** טבלת AGENTSFAMILY (הנחות סוכן לפי משפחות) — מאפשרת להגדיר מראש איזה סוכן אחראי על איזו משפחה. ראה מסמך: `SEGMENTATION_SOLUTION.md`

---

## 4. דשבורד מכירות (Sales)

### 4.1 תיאור כללי

דשבורד מכירות מציג ניתוח הכנסות בהשוואה לתקציב ולשנה קודמת.

**ציטוט מאלעד:**
> "בתחילת החודש יופיע תקציב ואפס מכירות, ולאט לאט הפער מצטמצם.
> בסוף החודש רוצים לראות שכולם ב-100% או מעל."

### 4.2 פילטרים

| # | פילטר | סוג | ברירת מחדל | מקור נתונים |
|---|-------|-----|------------|-------------|
| 1 | שנה | Multi-select | שנה נוכחית | `YEAR(DOCUMENTS.CURDATE)` |
| 2 | רבעון | Multi-select | רבעון נוכחי | `DATEPART(Q, CURDATE)` |
| 3 | תקופה | Date Range | חודש נוכחי | `DOCUMENTS.CURDATE` |
| 4 | סגמנט מכירות | Multi-select | הכל | `AGENTS.AGENTNAME` + `FAMILY.FAMILYNAME` |
| 5 | מפיץ | Multi-select | הכל | `AGENTS.AGENTCODE` |
| 6 | משפחת מוצרים | Multi-select | הכל | `FAMILY.FAMILYNAME` |
| 7 | חברה | Single-select | מאוחד | `ENVIRONMENT` |

**הערה:** "לא 50K מק"טים, אלא משפחות" — אלעד

### 4.3 כרטיסי סיכום (Summary Cards)

| מדד | תיאור | נוסחה | מקור (מסך.שדה) |
|-----|-------|-------|----------------|
| % Time Elapsed | אחוז הזמן שעבר בתקופה | יום נוכחי / ימים בתקופה × 100 | חישוב Power BI |
| % from Budget | אחוז ביצוע מתקציב | מכירות בפועל / תקציב × 100 | Excel (תקציב) + TRANSORDER (מכירות) |
| % from LY | אחוז משנה שעברה | מכירות השנה / מכירות אשתקד × 100 | TRANSORDER (שתי שנים) |

**הערה:** הכרטיסים יוצגו עבור MTD, QTD, ו-YTD בנפרד.

### 4.4 טבלת מכירות

| # | עמודה | תיאור | מקור (מסך.שדה) |
|---|-------|-------|----------------|
| 1 | BU | סגמנט עסקי | AGENTS.AGENTNAME + FAMILY.FAMILYNAME |
| 2 | Current Week | מכירות השבוע | TRANSORDER.PRICE × TQUANT (שבוע נוכחי) |
| 3 | MTD Sales | מכירות מתחילת החודש | TRANSORDER.PRICE × TQUANT (חודש נוכחי) |
| 4 | Full Month Budget | תקציב מלא לחודש | Excel (לפי לקוח + מק"ט) |
| 5 | MTD % from Budget | אחוז ביצוע | חישוב: עמודה 3 / עמודה 4 |
| 6 | MTD Last Year | אותה תקופה אשתקד | TRANSORDER (שנה קודמת) |
| 7 | MTD % from LY | אחוז משנה שעברה | חישוב: עמודה 3 / עמודה 6 |

> **הערת אלעד (09/02/2026):** עמודת MTD Budget (תקציב יחסי) הוסרה — לא נבצע מעקב מסוג זה. ההשוואה תהיה מול Full Month Budget בלבד.

### 4.5 קידוד צבעים

| צבע | תנאי | משמעות |
|-----|------|--------|
| ירוק | ≥ 100% | עמידה ביעד או מעל |
| כתום | 80% - 99% | קרוב ליעד, דורש תשומת לב |
| אדום | < 80% | מתחת ליעד |

### 4.6 גרפים

| גרף | סוג | נתונים |
|-----|-----|--------|
| התפלגות מכירות | Pie Chart | אחוז מכירות לכל סגמנט |
| ביצוע מול תקציב | Bar Chart | % מתקציב לכל סגמנט |

---

## 5. דשבורד הזמנות (Orders)

### 5.1 תיאור כללי

דשבורד הזמנות מציג ניתוח קצב כניסת הזמנות בהשוואה לשנה קודמת.

**הבדל מ-Sales:** להזמנות אין תקציב — רק השוואה לשנה שעברה.

**ציטוט מאלעד:**
> "אם רוצים לגדול 5%, צריך לראות שקצב כניסת ההזמנות הוא 5% מעל שנה שעברה."

### 5.2 פילטרים

| # | פילטר | סוג | ברירת מחדל | מקור נתונים |
|---|-------|-----|------------|-------------|
| 1 | שנה | Multi-select | שנה נוכחית | `YEAR(ORDERS.CURDATE)` |
| 2 | רבעון | Multi-select | רבעון נוכחי | `DATEPART(Q, CURDATE)` |
| 3 | תקופה | Date Range | חודש נוכחי | `ORDERS.CURDATE` |
| 4 | סגמנט מכירות | Multi-select | הכל | `AGENTS.AGENTNAME` + `FAMILY.FAMILYNAME` |
| 5 | מפיץ | Multi-select | הכל | `AGENTS.AGENTCODE` |
| 6 | מוצר/מק"ט (משפחה) | Multi-select | הכל | `FAMILY.FAMILYNAME` |
| 7 | חברה | Single-select | מאוחד | `ENVIRONMENT` |

### 5.3 כרטיסי סיכום (Summary Cards)

| מדד | תיאור | נוסחה | מקור (מסך.שדה) |
|-----|-------|-------|----------------|
| % Time Elapsed | אחוז הזמן שעבר בתקופה | יום נוכחי / ימים בתקופה × 100 | חישוב Power BI |
| % from LY | אחוז משנה שעברה | הזמנות השנה / הזמנות אשתקד × 100 | ORDERS.TOTPRICE (שתי שנים) |

### 5.4 טבלת הזמנות

| # | עמודה | תיאור | מקור (מסך.שדה) |
|---|-------|-------|----------------|
| 1 | BU | סגמנט עסקי | AGENTS.AGENTNAME + FAMILY.FAMILYNAME |
| 2 | Current Week | הזמנות השבוע | ORDERS.TOTPRICE (שבוע נוכחי) |
| 3 | MTD Orders | הזמנות מתחילת החודש | ORDERS.TOTPRICE (חודש נוכחי) |
| 4 | MTD Last Year | אותה תקופה אשתקד | ORDERS.TOTPRICE (שנה קודמת) |
| 5 | MTD % vs LY | אחוז משנה שעברה | חישוב: עמודה 3 / עמודה 4 |
| 6 | QTD Orders | הזמנות מתחילת הרבעון | ORDERS.TOTPRICE (רבעון נוכחי) |
| 7 | QTD Last Year | אותה תקופה אשתקד | ORDERS.TOTPRICE (שנה קודמת) |
| 8 | QTD % vs LY | אחוז משנה שעברה | חישוב: עמודה 6 / עמודה 7 |

### 5.5 קידוד צבעים

| צבע | תנאי | משמעות |
|-----|------|--------|
| ירוק | ≥ 0% | צמיחה — הזמנות גבוהות משנה שעברה |
| אדום | < 0% | ירידה — הזמנות נמוכות משנה שעברה |

---

## 6. דשבורד הזמנות לפי תאריך אספקה (Orders by Due Date)

### 6.1 תיאור כללי

דשבורד נפרד (Slide 3 ב-BI.pptx) להצגת הזמנות פתוחות לפי תאריך אספקה צפוי.

**ציטוט מאלעד:**
> "שאר הסגמנטים = נכנס היום יוצא מחר. בחו"ל יש backlog משמעותי."

**הערה:** רלוונטי בעיקר לסגמנט חו"ל, אבל מוצג כדשבורד עצמאי.

### 6.2 פילטרים

> **הערה:** אותם פילטרים כמו בדשבורד מכירות והזמנות — כפי שמוצג בדוגמת Tuttnauer של אליק.

| # | פילטר | סוג | ברירת מחדל | מקור נתונים |
|---|-------|-----|------------|-------------|
| 1 | שנה | Multi-select | שנה נוכחית | `YEAR(ORDERITEMS.DUEDATE)` |
| 2 | רבעון | Multi-select | רבעון נוכחי | `DATEPART(Q, DUEDATE)` |
| 3 | תקופה | Date Range | חודש נוכחי | `ORDERITEMS.DUEDATE` |
| 4 | סגמנט מכירות | Multi-select | הכל | `AGENTS.AGENTNAME` + `FAMILY.FAMILYNAME` |
| 5 | מפיץ | Multi-select | הכל | `AGENTS.AGENTCODE` |
| 6 | מוצר/מק"ט (משפחה) | Multi-select | הכל | `FAMILY.FAMILYNAME` |
| 7 | חברה | Single-select | מאוחד | `ENVIRONMENT` |

### 6.3 טבלת הזמנות לפי תאריך אספקה

| # | עמודה | תיאור | מקור (מסך.שדה) |
|---|-------|-------|----------------|
| 1 | Due Date | תאריך אספקה צפוי | ORDERITEMS.DUEDATE |
| 2 | Open Orders | סכום הזמנות פתוחות | ORDERITEMS.QPRICE (פילטר: ORDERITEMS.CLOSED <> 'C') |
| 3 | Distributor | מפיץ | AGENTS.AGENTNAME |
| 4 | BU | סגמנט עסקי | AGENTS.AGENTNAME + FAMILY.FAMILYNAME |

> **❓ שאלה #2 לראובן:** במסך הזמנות — איזה שדה מציין סטטוס פתוח/סגור? (ORDERITEMS.CLOSED = 'C'?)

### 6.4 תקופות

| עמודה | תיאור | מקור |
|-------|-------|------|
| Monthly budget | תקציב חודשי | Excel |
| Monthly sales last year | מכירות שנה קודמת | ORDERS (שנה קודמת) |
| רבעוני | Q1, Q2, Q3, Q4 | `DATEPART(Q, DUEDATE)` |
| שנתי | 2023, 2024, 2025 | `YEAR(DUEDATE)` |

---

## 7. מקורות נתונים

### 7.1 מערכת מקור

- **מערכת:** Priority ERP
- **גישה:** Priority OData
- **הרשאות:** Read-only בלבד

### 7.2 טבלאות נדרשות

**סטטוס: ✅ נבדק מול סכמת פריוריטי (09/02/2026)**

| טבלה | תיאור | שדות מפתח ל-BI | OData Entity |
|-------|--------|----------------|-------------|
| `DOCUMENTS` | תעודות משלוח (כותרת) | DOC, CUST, AGENT, TOTPRICE, CURDATE | `DOCUMENTS_D` |
| `TRANSORDER` | שורות תעודת משלוח | DOC, PART, TQUANT, PRICE | תת-טופס של DOCUMENTS_D |
| `ORDERS` | הזמנות לקוח | ORD, CUST, AGENT, TOTPRICE, CURDATE | `ORDERS` |
| `ORDERITEMS` | פירוטי הזמנה | ORD, PART, TQUANT, QPRICE, DUEDATE, CLOSED | תת-טופס של ORDERS |
| `INVOICEITEMS` | פרוט חשבוניות | IV, PART, AGENT, QPRICE | `AINVOICES` |
| `CUSTOMERS` | לקוחות | CUST, CUSTDES, AGENT | `CUSTOMERS` |
| `AGENTS` | סוכנים | AGENT, AGENTNAME | `AGENTS` |
| `PART` | מוצרים | PART, PARTDES, FAMILY | `LOGPART` |
| `FAMILY` | משפחות מוצר | FAMILY, FAMILYNAME, FAMILYDES | `FAMILY_LOG` |
| `Excel` | נתוני תקציב | לפי לקוח + מק"ט + חודש | ייבוא ידני |

### 7.3 שרשרת קשרים (Data Model)

```
תעודת משלוח (DOCUMENTS)
  ├── AGENT ──▶ סוכנים (AGENTS) ──▶ שם הסוכן
  ├── CUST ───▶ לקוחות (CUSTOMERS) ──▶ שם הלקוח
  └── שורות (TRANSORDER)
        └── PART ──▶ מוצרים (PART)
                       └── FAMILY ──▶ משפחות מוצר (FAMILY)

הזמנות (ORDERS)
  ├── AGENT ──▶ סוכנים (AGENTS)
  ├── CUST ───▶ לקוחות (CUSTOMERS)
  └── פירוטים (ORDERITEMS)
        └── PART ──▶ מוצרים (PART) ──▶ FAMILY
```

### 7.4 מקור נתוני מכירות

**החלטה (ראובן, 09/02/2026):** ✅
- **במהלך החודש:** מעקב על פי **תעודות משלוח** (DOCUMENTS + TRANSORDER)
- **לאחר סגירת החודש:** לפי **חשבוניות** (INVOICEITEMS)

### 7.5 מקור נתוני תקציב

**החלטה (ראובן, 09/02/2026):** ✅
- **מקור:** קובץ **Excel** — מפורט לפי לקוח ולפי מק"ט
- **אופן טעינה:** ייבוא ידני ל-Power BI (או SharePoint link)

### 7.6 לוגיקת סגמנטציה

**מבוסס על ניתוח דוח 740 (09/02/2026):** ✅

הסגמנטציה נגזרת מנתוני המכירות עצמם — ללא טבלת מיפוי חיצונית:

1. **סוכן** — שדה AGENT בתעודה/הזמנה
2. **משפחת מוצרים** — שדה FAMILY על המוצר (PART.FAMILY)
3. **קיבוץ** — קבוצת מוצרים ראשית (פרמטר 2 על המוצר)

ראה מסמך מפורט: `tasks/011-bi-dashboards/SEGMENTATION_SOLUTION.md`

---

## 8. דרישות טכניות

### 8.1 גישה לנתונים

**SQL — לא מומלץ:**
- Priority ממליצה לא לגשת ל-database ישירות
- Read-only אבל אין מעקב, הכל פתוח
- בעיית אבטחה — אם מישהו פורץ, יש גישה לכל המידע

**OData — נבחר ✓:**
- פרוטוקול סטנדרטי, Power BI תומך native
- חיבור ישיר ללא קוד מותאם
- הרשאות per table
- מבוקר, יש audit

**החלטה:** חיבור דרך Priority OData. יורי יתן לאליק VPN + OData credentials.

### 8.2 דרישות תצוגה

- מספרים באלפים (לא 997,000 אלא 997K)
- Default view: רבעון נוכחי, כל הסגמנטים
- ויזואליקה: קווים/פאי/גרפים — אפשר לשנות אחר כך

### 8.3 חברות

| חברה | הערות |
|------|-------|
| להבות | — |
| פיירטק | — |
| מאוחד | ברירת מחדל |

---

## 9. שאלות פתוחות

| # | שאלה | אחראי | סטטוס |
|---|------|-------|-------|
| 1 | מיפוי סגמנטים — איזה שדה/מסך בפריוריטי? | ראובן | ✅ נבדק — AGENT + FAMILY מתוך נתוני מכירות (כמו דוח 740) |
| 2 | סטטוס הזמנה — איזה שדה במסך ORDERS? | ראובן | ❓ פתוח — ORDERITEMS.CLOSED = 'C'? |
| 3 | מסך מקור למכירות — DOCUMENTS_D / INVOICES / אחר? | ראובן | ✅ תעודות משלוח (שוטף) + חשבוניות (סוף חודש) |
| 4 | מקור תקציב — Excel או מסך בפריוריטי? מבנה? | ראובן | ✅ Excel מפורט לפי לקוח ומק"ט |
| 5 | פז ומירי — ביחד או בנפרד? | אלעד | ✅ ביחד (אלעד אישר 07/02) |
| 6 | הגדרת OData access למסכים | יורי | ❓ פתוח |
| 7 | דוח 740 — להבין מקורות נתונים | ראובן + יורי | ✅ נבדק — pivot על DOCUMENTS.AGENT + PART.FAMILY |

---

## 10. אישורים

| תפקיד | שם | חתימה | תאריך |
|-------|-----|-------|-------|
| מנכ"ל | אלעד | _______ | _______ |
| סמנכ"ל כספים | ראובן | _______ | _______ |
| IT | יורי כץ | ✓ | 04/02/2026 |

---

## נספח א': תהליך העבודה המוסכם

1. **Elad** — מכין mockup דומה ל-Orders dashboard
2. **Yuri** — מכין draft ויזואלי + מיפוי נתונים
   - לכל שדה: מאיזו טבלה בפריוריטי
   - תהליך איטרטיבי עם הצוות
3. **הגדרת acceptance criteria** — מה בודקים ב-Beta test
4. **פגישה עם אליק** — להציג את האפיון המדויק
5. **אליק** — נותן הצעת מחיר ובונה
6. **בדיקות** — מוודאים כל נתון מול פריוריטי

**ציטוט מיורי:**
> "אנחנו חייבים להגיע למצב שברגע שאליק סיים, אנחנו בודקים ואומרים 'כן, זה מתאים'.
> כמה שאנחנו נדייק עכשיו, יהיה לנו פחות הרפתקאות אחר כך."

**ציטוט מאלעד:**
> "נכון. לא רוצים מצב של 'לא הבנתי, לא התכוונתי, זה לא בסקופ'."

---

**סוף מסמך**

מסמך מס' LHV-BI-SPEC-001 | גרסה 2.1 | סודי — לשימוש פנימי בלבד
